<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Frontend File Service</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Debug Frontend File Service</h1>
    <button onclick="testFileService()">Test File Service</button>
    <div id="output"></div>

    <script>
        // 从.env文件中读取配置（需要手动设置）
        const SUPABASE_URL = 'https://vcgythhenulnwuindgyx.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjZ3l0aGhlbnVsbnd1aW5kZ3l4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MjYwNDcsImV4cCI6MjA3MzQwMjA0N30.Go2s1EwYsmG3Uj9Fiy2QB0eo-GcKTd3gwiRfBkRMKjA'
        
        const { createClient } = supabase
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        function log(message) {
            console.log(message)
            const output = document.getElementById('output')
            output.innerHTML += '<div>' + JSON.stringify(message, null, 2) + '</div>'
        }
        
        async function testFileService() {
            try {
                log('=== 测试前端文件服务 ===')
                
                // 1. 获取背景设置
                log('\n1. 获取背景设置:')
                const { data: lightSetting } = await supabaseClient
                    .from('settings')
                    .select('value')
                    .eq('key', 'background_light')
                    .single()
                
                const { data: darkSetting } = await supabaseClient
                    .from('settings')
                    .select('value')
                    .eq('key', 'background_dark')
                    .single()
                
                log('Light background setting: ' + lightSetting?.value)
                log('Dark background setting: ' + darkSetting?.value)
                
                // 2. 模拟前端fileService.getBackgroundsList()
                log('\n2. 模拟前端fileService.getBackgroundsList():')
                const allFiles = []
                const themes = ['light', 'dark']
                
                for (const theme of themes) {
                    const { data, error } = await supabaseClient.storage
                        .from('backgrounds')
                        .list(theme, {
                            limit: 100,
                            sortBy: { column: 'created_at', order: 'desc' }
                        })
                    
                    if (error) {
                        log(`获取${theme}主题背景列表失败: ${error.message}`)
                        continue
                    }
                    
                    const themeFiles = data?.map(file => {
                        // 从文件名中提取ID（去掉主题后缀和扩展名）
                        const fileId = file.name.split('_')[0]
                        return {
                            id: fileId,
                            name: file.name,
                            path: `${theme}/${file.name}`,
                            url: supabaseClient.storage.from('backgrounds').getPublicUrl(`${theme}/${file.name}`).data.publicUrl,
                            theme: theme
                        }
                    }) || []
                    
                    allFiles.push(...themeFiles)
                }
                
                log('所有文件:')
                log(allFiles.map(f => ({ id: f.id, name: f.name, path: f.path, theme: f.theme })))
                
                // 3. 测试匹配逻辑
                log('\n3. 测试匹配逻辑:')
                const testSettings = [lightSetting?.value, darkSetting?.value].filter(Boolean)
                
                for (const setting of testSettings) {
                    log(`\n查找设置: ${setting}`)
                    
                    // 模拟前端查找逻辑
                    const matchedFile = allFiles.find(file => 
                        file.id === setting || 
                        file.name === setting || 
                        file.path === setting
                    )
                    
                    if (matchedFile) {
                        log('✅ 找到匹配文件:')
                        log({
                            id: matchedFile.id,
                            name: matchedFile.name,
                            path: matchedFile.path,
                            url: matchedFile.url,
                            theme: matchedFile.theme
                        })
                    } else {
                        log('❌ 未找到匹配文件')
                        log('可用文件ID: ' + allFiles.map(f => f.id).join(', '))
                        log('可用文件名: ' + allFiles.map(f => f.name).join(', '))
                        log('可用文件路径: ' + allFiles.map(f => f.path).join(', '))
                    }
                }
                
            } catch (error) {
                log('测试失败: ' + error.message)
                console.error('测试失败:', error)
            }
        }
    </script>
</body>
</html>